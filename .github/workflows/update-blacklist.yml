name: Update Blacklist Data

on:
  schedule:
    - cron: "0 0 * * *"   # UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:

jobs:
  update-blacklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create target directory
      run: mkdir -p bird-shield-blocking/share/blacklist

    - name: Fetch JSON & extract IDs using real filename
      run: |
        SOURCE_URL="https://basedinchina.com/api/users/all"

        echo "ğŸ”— è¯·æ±‚æ•°æ®æº: $SOURCE_URL"

        # --------------- åŠ å¼ºçš„ curlï¼Œè¯·æ±‚æ›´å®¹æ˜“æˆåŠŸ ----------------
        RESPONSE=$(curl -s -L \
          --retry 3 --retry-delay 2 \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
          -H "Referer: https://basedinchina.com/" \
          -w "HTTP_STATUS:%{http_code}\nFINAL_URL:%{url_effective}" \
          -o temp.json \
          "$SOURCE_URL")

        HTTP_STATUS=$(echo "$RESPONSE" | sed -n 's/.*HTTP_STATUS:\([0-9]*\).*/\1/p')
        FINAL_URL=$(echo "$RESPONSE" | sed -n 's/.*FINAL_URL:\(.*\)/\1/p')

        echo "ğŸ“ æœ€ç»ˆåœ°å€: $FINAL_URL"
        echo "ğŸ“¡ HTTP çŠ¶æ€ç : $HTTP_STATUS"

        # --------------- é”™è¯¯å¤„ç† ----------------
        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ å¤±è´¥ï¼šAPI è¿”å›çŠ¶æ€ç  $HTTP_STATUS"
          exit 1
        fi

        if [ ! -s temp.json ]; then
          echo "âŒ å¤±è´¥ï¼šä¸‹è½½åˆ°çš„ JSON æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi

        # --------------- æå–çœŸå®æ–‡ä»¶å ----------------
        REAL_FILENAME=$(basename "$FINAL_URL")
        TARGET_JSON="bird-shield-blocking/share/blacklist/$REAL_FILENAME"

        mv temp.json "$TARGET_JSON"
        echo "ğŸ’¾ JSON ä¿å­˜ä¸º: $TARGET_JSON"

        # --------------- ç”Ÿæˆ .txt æ–‡ä»¶ ----------------
        TXT_FILENAME="${REAL_FILENAME%.*}.txt"
        TARGET_TXT="bird-shield-blocking/share/blacklist/$TXT_FILENAME"

        jq -r '.users[].id' "$TARGET_JSON" > "$TARGET_TXT"
        echo "ğŸ’¾ ç”¨æˆ· ID ä¿å­˜åˆ°: $TARGET_TXT"

    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name  "GitHub Action"

        git add bird-shield-blocking/share/blacklist/

        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”„ æ›´æ–°é»‘åå•æ•°æ® - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
        fi
