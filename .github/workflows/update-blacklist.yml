name: Update Blacklist Data

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-blacklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create target directory
      run: mkdir -p bird-shield-blocking/share/blacklist

    # ========================================================
    # â‘  Archive.org æ•°æ®æºï¼ˆå·²æŒ‰ä½ è¦æ±‚å®Œå…¨æ³¨é‡Šï¼‰
    # ========================================================
    # - name: Fetch latest JSON from Archive.org
    #   run: |
    #     BASE_URL="https://archive.org/download/based-in-china"
    #     echo "ğŸ” æ­£åœ¨æŸ¥è¯¢æœ€æ–° JSON æ–‡ä»¶â€¦â€¦"
    #
    #     LATEST_FILE=$(curl -s "$BASE_URL/" \
    #       | grep -o 'based-in-china-accounts-export-full-[^"]*\.json' \
    #       | sort | tail -n 1)
    #
    #     if [ -z "$LATEST_FILE" ]; then
    #       echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° JSON æ–‡ä»¶"
    #       exit 1
    #     fi
    #
    #     echo "ğŸ“„ æœ€æ–° JSON æ–‡ä»¶: $LATEST_FILE"
    #
    #     FILE_URL="$BASE_URL/$LATEST_FILE"
    #     echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½: $FILE_URL"
    #
    #     curl -s -L -o temp_archive.json "$FILE_URL"
    #
    #     if [ ! -s temp_archive.json ]; then
    #       echo "âŒ JSON ä¸‹è½½å¤±è´¥ï¼ˆç©ºæ–‡ä»¶ï¼‰"
    #       exit 1
    #     fi
    #
    #     TARGET_JSON="bird-shield-blocking/share/blacklist/$LATEST_FILE"
    #
    #     # å¦‚æœå†…å®¹æœªå˜ï¼Œä¸è¦†ç›–ï¼Œä¸æäº¤
    #     if [ -f "$TARGET_JSON" ] && cmp -s temp_archive.json "$TARGET_JSON"; then
    #       echo "â„¹ï¸ Archive.org å†…å®¹æœªå˜åŒ–ï¼Œè·³è¿‡ä¿å­˜"
    #       rm temp_archive.json
    #     else
    #       mv temp_archive.json "$TARGET_JSON"
    #       echo "ğŸ’¾ Archive.org JSON ä¿å­˜ä¸º: $TARGET_JSON"
    #
    #       TXT1="bird-shield-blocking/share/blacklist/${LATEST_FILE%.*}.txt"
    #       jq -r '.users[].id' "$TARGET_JSON" > "$TXT1"
    #       echo "ğŸ’¾ ä» Archive.org æå– ID åˆ°: $TXT1"
    #     fi

    # ========================================================
    # â‘¡ æ­£å¼å¯ç”¨ï¼šchina.jsonl æ•°æ®æºï¼ˆå« no-change æ£€æµ‹ï¼‰
    # ========================================================
    - name: Fetch china.jsonl and generate china.txt
      run: |
        SRC2_URL="https://raw.githubusercontent.com/pluto0x0/X_based_china/refs/heads/main/china.jsonl"

        echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ china.jsonl: $SRC2_URL"
        curl -s -L -o new_china.jsonl "$SRC2_URL"

        if [ ! -s new_china.jsonl ]; then
          echo "âŒ ä¸‹è½½ china.jsonl å¤±è´¥"
          exit 1
        fi

        TARGET_JSONL="bird-shield-blocking/share/blacklist/china.jsonl"
        TARGET_TXT="bird-shield-blocking/share/blacklist/china.txt"

        # ------- å†…å®¹æœªå˜ï¼šè·³è¿‡å†™å…¥ -------
        if [ -f "$TARGET_JSONL" ] && cmp -s new_china.jsonl "$TARGET_JSONL"; then
          echo "â„¹ï¸ china.jsonl å†…å®¹æœªå˜åŒ–ï¼Œè·³è¿‡å†™å…¥ä¸ç”Ÿæˆ txt"
          rm new_china.jsonl
        else
          mv new_china.jsonl "$TARGET_JSONL"
          echo "ğŸ’¾ china.jsonl å·²ä¿å­˜ä¸º: $TARGET_JSONL"

          jq -r '.info.rest_id' "$TARGET_JSONL" > "$TARGET_TXT"
          echo "ğŸ’¾ ä» china.jsonl æå– ID åˆ°: $TARGET_TXT"
        fi

    # ========================================================
    # â‘¢ Commitï¼ˆè‡ªåŠ¨ skip æ— å˜åŒ–æƒ…å†µï¼‰
    # ========================================================
    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name  "GitHub Action"

        git add bird-shield-blocking/share/blacklist/

        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”„ æ›´æ–°é»‘åå•æ•°æ® - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
        fi
