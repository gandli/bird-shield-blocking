name: Update Blacklist Data

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-blacklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create target directory
      run: mkdir -p bird-shield-blocking/share/blacklist

    - name: Fetch latest JSON from Archive.org
      run: |
        BASE_URL="https://archive.org/download/based-in-china"

        echo "ğŸ” æ­£åœ¨æŸ¥è¯¢æœ€æ–° JSON æ–‡ä»¶â€¦â€¦"

        # è‡ªåŠ¨åˆ—ç›®å½•ï¼Œæå–æ‰€æœ‰ json æ–‡ä»¶åï¼Œæ’åºåå–æœ€åä¸€ä¸ªï¼ˆæœ€æ–°ï¼‰
        LATEST_FILE=$(curl -s "$BASE_URL/" \
          | grep -o 'based-in-china-accounts-export-full-[^"]*\.json' \
          | sort | tail -n 1)

        if [ -z "$LATEST_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° JSON æ–‡ä»¶"
          exit 1
        fi

        echo "ğŸ“„ æœ€æ–° JSON æ–‡ä»¶: $LATEST_FILE"

        FILE_URL="$BASE_URL/$LATEST_FILE"

        echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½: $FILE_URL"

        curl -s -L -o temp.json "$FILE_URL"

        if [ ! -s temp.json ]; then
          echo "âŒ JSON ä¸‹è½½å¤±è´¥ï¼ˆç©ºæ–‡ä»¶ï¼‰"
          exit 1
        fi

        TARGET_JSON="bird-shield-blocking/share/blacklist/$LATEST_FILE"
        mv temp.json "$TARGET_JSON"

        echo "ğŸ’¾ JSON ä¿å­˜ä¸º: $TARGET_JSON"

        # ---------------- ç”Ÿæˆ txt ----------------
        TXT_FILENAME="${LATEST_FILE%.*}.txt"
        TARGET_TXT="bird-shield-blocking/share/blacklist/$TXT_FILENAME"

        jq -r '.users[].id' "$TARGET_JSON" > "$TARGET_TXT"
        echo "ğŸ’¾ ç”¨æˆ· ID ä¿å­˜åˆ°: $TARGET_TXT"

    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name  "GitHub Action"

        git add bird-shield-blocking/share/blacklist/

        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”„ æ›´æ–°é»‘åå•æ•°æ® - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
        fi
