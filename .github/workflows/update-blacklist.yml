name: Update Blacklist Data (Real Filename for Both JSON and IDs)

on:
  schedule:
    # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update-blacklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create target directory
      run: |
        mkdir -p bird-shield-blocking/share/blacklist

    - name: Fetch JSON & extract IDs using real filename
      run: |
        # ğŸ”— æ•°æ®æº URLï¼ˆä¼šé‡å®šå‘åˆ°çœŸå® JSON æ–‡ä»¶ï¼‰
        SOURCE_URL="https://basedinchina.com/api/users/all"

        echo "ğŸ”— æ­£åœ¨è¯·æ±‚æ•°æ®æº: $SOURCE_URL"

        # ä½¿ç”¨ curl è·Ÿéšé‡å®šå‘ï¼ŒåŒæ—¶è·å–æœ€ç»ˆ URL
        RESPONSE=$(curl -s -L -w "HTTP_STATUS:%{http_code}\nFINAL_URL:%{url_effective}" -o temp.json "$SOURCE_URL")

        # æå– HTTP çŠ¶æ€ç  å’Œ æœ€ç»ˆ URL
        HTTP_STATUS=$(echo "$RESPONSE" | sed -n 's/.*HTTP_STATUS:\([0-9]*\).*/\1/p')
        FINAL_URL=$(echo "$RESPONSE" | sed -n 's/.*FINAL_URL:\(.*\)/\1/p')

        echo "âœ… æœ€ç»ˆçŠ¶æ€ç : $HTTP_STATUS"
        echo "ğŸ“ æœ€ç»ˆä¸‹è½½åœ°å€: $FINAL_URL"

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "âŒ è¯·æ±‚å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_STATUS"
          exit 1
        fi

        # ä»æœ€ç»ˆ URL ä¸­æå–æ–‡ä»¶åï¼ˆå¦‚ based-in-china-...2025-11-24T12-58-31-024Z.jsonï¼‰
        REAL_FILENAME=$(basename "$FINAL_URL")
        echo "ğŸ“¦ æå–åˆ°çš„çœŸå®æ–‡ä»¶å: $REAL_FILENAME"

        # ä¿å­˜åŸå§‹ JSONï¼Œä½¿ç”¨çœŸå®æ–‡ä»¶å
        TARGET_JSON_PATH="bird-shield-blocking/share/blacklist/$REAL_FILENAME"
        mv temp.json "$TARGET_JSON_PATH"
        echo "ğŸ’¾ åŸå§‹ JSON å·²ä¿å­˜ä¸º: $TARGET_JSON_PATH"

        # æå–æ‰€æœ‰ç”¨æˆ·çš„ idï¼Œå¹¶ä¿å­˜ä¸ºåŒåä½†æ‰©å±•åä¸º .txt çš„æ–‡ä»¶
        TXT_FILENAME="${REAL_FILENAME%.*}.txt"  # æŠŠ .json æ›¿æ¢ä¸º .txt
        TARGET_TXT_PATH="bird-shield-blocking/share/blacklist/$TXT_FILENAME"

        jq -r '.users[].id' "$TARGET_JSON_PATH" > "$TARGET_TXT_PATH"
        echo "ğŸ’¾ ç”¨æˆ· IDs å·²æå–åˆ°: $TARGET_TXT_PATH ï¼ˆæ¯è¡Œä¸€ä¸ª idï¼‰"

    - name: Commit and push
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Action"

        # æ·»åŠ è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼ˆJSON å’ŒåŒåçš„ TXTï¼‰
        git add bird-shield-blocking/share/blacklist/

        if ! git diff --staged --quiet; then
          git commit -m "ğŸ”„ æ›´æ–°é»‘åå•æ•°æ® - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin ${{ github.ref_name }}
          echo "âœ… æ•°æ®å·²æ¨é€è‡³ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æ•°æ®éœ€è¦æäº¤"
        fi
