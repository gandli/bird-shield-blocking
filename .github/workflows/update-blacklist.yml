name: Update Blacklist Data

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-blacklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Create target directory
      run: mkdir -p bird-shield-blocking/share/blacklist

    # -------------------------
    # â‘  ä¸‹è½½æœ€æ–° Archive.org JSON
    # -------------------------
    - name: Fetch latest JSON from Archive.org
      run: |
        BASE_URL="https://archive.org/download/based-in-china"

        echo "ğŸ” æ­£åœ¨æŸ¥è¯¢æœ€æ–° JSON æ–‡ä»¶â€¦â€¦"

        LATEST_FILE=$(curl -s "$BASE_URL/" \
          | grep -o 'based-in-china-accounts-export-full-[^"]*\.json' \
          | sort | tail -n 1)

        if [ -z "$LATEST_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° JSON æ–‡ä»¶"
          exit 1
        fi

        echo "ğŸ“„ æœ€æ–° JSON æ–‡ä»¶: $LATEST_FILE"

        FILE_URL="$BASE_URL/$LATEST_FILE"

        echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½: $FILE_URL"
        curl -s -L -o temp_archive.json "$FILE_URL"

        if [ ! -s temp_archive.json ]; then
          echo "âŒ JSON ä¸‹è½½å¤±è´¥ï¼ˆç©ºæ–‡ä»¶ï¼‰"
          exit 1
        fi

        TARGET_JSON="bird-shield-blocking/share/blacklist/$LATEST_FILE"
        mv temp_archive.json "$TARGET_JSON"

        echo "ğŸ’¾ Archive.org JSON ä¿å­˜ä¸º: $TARGET_JSON"

        # ç”Ÿæˆå¯¹åº” txt
        TXT1="bird-shield-blocking/share/blacklist/${LATEST_FILE%.*}.txt"
        jq -r '.users[].id' "$TARGET_JSON" > "$TXT1"
        echo "ğŸ’¾ ä» Archive.org æå– ID åˆ°: $TXT1"

    # -------------------------------
    # â‘¡ ä¸‹è½½ç¬¬äºŒæ•°æ®æºï¼šchina.jsonl
    # -------------------------------
    - name: Fetch china.jsonl and generate china.txt
      run: |
        SRC2_URL="https://raw.githubusercontent.com/pluto0x0/X_based_china/refs/heads/main/china.jsonl"
        echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ china.jsonl: $SRC2_URL"

        curl -s -L -o china.jsonl "$SRC2_URL"

        if [ ! -s china.jsonl ]; then
          echo "âŒ ä¸‹è½½ china.jsonl å¤±è´¥"
          exit 1
        fi

        TARGET_JSONL="bird-shield-blocking/share/blacklist/china.jsonl"
        mv china.jsonl "$TARGET_JSONL"
        echo "ğŸ’¾ china.jsonl å·²ä¿å­˜ä¸º: $TARGET_JSONL"

        # æå– ID â†’ china.txt
        TARGET_TXT="bird-shield-blocking/share/blacklist/china.txt"
        jq -r '.info.rest_id' "$TARGET_JSONL" > "$TARGET_TXT"

        echo "ğŸ’¾ ä» china.jsonl æå– ID åˆ°: $TARGET_TXT"

    # -------------------------------
    # â‘¢ æäº¤
    # -------------------------------
    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name  "GitHub Action"

        git add bird-shield-in-blocking/share/blacklist/ 2>/dev/null || true
        git add bird-shield-blocking/share/blacklist/

        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”„ æ›´æ–°é»‘åå•æ•°æ® - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
        fi
